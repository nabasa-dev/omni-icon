import{t as e}from"./webcomponents/omni-icon-D4fSwBeM.js";function t(e){return new Promise((t,n)=>{e.oncomplete=e.onsuccess=()=>t(e.result),e.onabort=e.onerror=()=>n(e.error)})}function n(e,n){let r,i=()=>{if(r)return r;let i=indexedDB.open(e);return i.onupgradeneeded=()=>i.result.createObjectStore(n),r=t(i),r.then(e=>{e.onclose=()=>r=void 0},()=>{}),r};return(e,t)=>i().then(r=>t(r.transaction(n,e).objectStore(n)))}var r;function i(){return r||=n(`keyval-store`,`keyval`),r}function a(e,n=i()){return n(`readonly`,n=>t(n.get(e)))}function o(e,n,r=i()){return r(`readwrite`,r=>(r.put(n,e),t(r.transaction)))}let s=function(e){return e.NO_NAME=`NO_NAME`,e.NAME_NOT_FOUND=`NAME_NOT_FOUND`,e.INVALID_FORMAT=`INVALID_FORMAT`,e.FETCH_FAILED=`FETCH_FAILED`,e.INVALID_RESPONSE=`INVALID_RESPONSE`,e}({});var c=class extends Error{constructor(e,t,n){super(t),this.type=e,this.originalError=n}},l=`/wp-json/omni-icon/v1/icon/item`,u=`oiwc-cache`,d=4,f=new Map,p=new Map,m=[],h=0;async function g(e,t,n,r){let{signal:i,priority:a=0}=r??{},o=f.get(e);if(o)return o;let s=await D(e);if(s)return f.set(e,s),s;let c=_(e,t,n,a);return y(c,i),c.promise}function _(e,t,n,r){let i=p.get(e);return i?!i.queueItem.started&&r>i.queueItem.priority&&(i.queueItem.priority=r,C()):(i=v(e,t,n,r),p.set(e,i)),i}function v(e,t,n,r){let i=new AbortController,a=new Set,o,s={iconName:e,abortController:i,consumers:a,queueItem:{},promise:Promise.resolve(``)};return s.promise=new Promise((a,c)=>{o={iconName:e,prefix:t,name:n,priority:r,resolve:a,reject:c,abortController:i,cleanup:()=>x(s),started:!1},s.queueItem=o,S(o),T()}).then(t=>(f.set(e,t),O(e,t),t)).finally(()=>{x(s),p.delete(e)}),s}function y(e,t){let n={signal:t??null};if(e.consumers.add(n),t){let r=()=>b(e,n);n.handler=r,t.addEventListener(`abort`,r),t.aborted&&r()}}function b(e,t){if(e.consumers.has(t)&&(t.signal&&t.handler&&t.signal.removeEventListener(`abort`,t.handler),e.consumers.delete(t),!(e.consumers.size>0))){if(!e.queueItem.started){w(e.queueItem),e.queueItem.cleanup(),e.queueItem.reject(new c(s.FETCH_FAILED,`Icon request aborted before start for "${e.iconName}"`));return}e.abortController.abort()}}function x(e){e.consumers.forEach(e=>{e.signal&&e.handler&&e.signal.removeEventListener(`abort`,e.handler)}),e.consumers.clear()}function S(e){m.push(e),C()}function C(){m.sort((e,t)=>t.priority-e.priority)}function w(e){let t=m.indexOf(e);t!==-1&&m.splice(t,1)}function T(){for(;h<d&&m.length>0;){let e=m.shift();if(!e)break;e.started=!0,h++,E(e).finally(()=>{h--,e.cleanup(),T()})}}async function E(e){try{let t=await k(e.iconName,e.prefix,e.name,e.abortController);e.resolve(t)}catch(t){if(t instanceof DOMException&&t.name===`AbortError`){e.reject(new c(s.FETCH_FAILED,`Icon request aborted for "${e.iconName}"`));return}e.reject(t instanceof Error?t:Error(`Unknown error`))}}async function D(e){try{let t=await a(`${u}.${e}`);return typeof t==`string`?t:void 0}catch{return}}async function O(e,t){try{await o(`${u}.${e}`,t)}catch{}}async function k(e,t,n,r){try{let i=`${l}/${encodeURIComponent(t)}/${encodeURIComponent(n)}`,a=await fetch(i,{headers:{Accept:`application/json`},signal:r?.signal});if(!a.ok)throw new c(a.status===404?s.NAME_NOT_FOUND:s.FETCH_FAILED,a.status===404?`We couldn't find an icon with the provided name.`:`Failed to fetch icon: ${a.status} ${a.statusText}`);let o=await a.json();if(!o.svg)throw new c(s.INVALID_RESPONSE,`Invalid API response: missing SVG data for "${e}"`);return o.svg}catch(t){throw t instanceof c||t instanceof DOMException&&t.name===`AbortError`?t:new c(s.FETCH_FAILED,`Network error while fetching icon "${e}"`,t instanceof Error?t:void 0)}}var A={fetchIcon:g};typeof window<`u`&&(window.IconRegistry=A);var j=class t{static ICON_NAME_SEPARATOR=`:`;static FALLBACK_ICON=`tabler:error-404`;static FALLBACK_PRIORITY=10;static RESERVED_ATTRS=new Set([`name`,`id`,`role`,`aria-expanded`,`tabindex`]);static SVG_ATTRS=new Set([`xmlns`,`viewBox`,`aria-hidden`,`focusable`]);static CLEANUP_ATTRS=[`data-oiwc-state`,`data-oiwc-error-type`,`data-oiwc-original-icon`,`data-oiwc-expanded`,`role`,`aria-expanded`,`tabindex`];states=new WeakMap;static errorObserverPromise=null;static errorObserverLoaded=!1;getState(e){let t=this.states.get(e);return t||(t={renderStatus:`loading`,renderAbortController:null,lastError:null,activeIconName:null,mutationObserver:null,originalWidth:null,originalHeight:null,cachedSvgElement:null},this.states.set(e,t)),t}attachRenderer(e){let t=this.getState(e);if(e.hasAttribute(`data-prerendered`)){t.renderStatus=`rendered`,this.observeElement(e);return}this.renderIcon(e),this.observeElement(e)}detachRenderer(e){let t=this.getState(e);t.renderAbortController?.abort(),t.renderAbortController=null,t.activeIconName=null,t.originalWidth=null,t.originalHeight=null,t.cachedSvgElement=null,t.mutationObserver&&=(t.mutationObserver.disconnect(),null),this.states.delete(e)}restartAnimation(e){let t=this.getState(e),n=t.cachedSvgElement||e.querySelector(`svg`);if(n&&t.renderStatus===`rendered`)try{n.setCurrentTime?.(0)}catch{this.renderIcon(e)}}observeElement(e){let t=this.getState(e);t.mutationObserver||(t.mutationObserver=new MutationObserver(n=>{n.forEach(n=>{if(n.type===`attributes`){let r=n.attributeName;if(r===`data-prerendered`&&e.hasAttribute(`data-prerendered`)){t.renderAbortController?.abort(),t.renderStatus=`rendered`;return}if(r===`data-prerendered`&&!e.hasAttribute(`data-prerendered`)){this.renderIcon(e);return}if(e.hasAttribute(`data-prerendered`))return;r===`name`?this.renderIcon(e):t.renderStatus===`rendered`&&this.updateSvgAttributes(e)}})}),t.mutationObserver.observe(e,{attributes:!0,attributeOldValue:!1}))}getConfig(e){let t=this.getState(e),n=e.getAttribute(`width`),r=e.getAttribute(`height`),i=n||t.originalWidth||``,a=r||t.originalHeight||``;return n&&!r?a=n:r&&!n&&(i=r),{name:e.getAttribute(`name`)||``,width:i,height:a,color:e.getAttribute(`color`)||void 0}}parseIconName(e){if(!e)throw new c(s.NO_NAME,`No icon name specified`);let n=e.indexOf(t.ICON_NAME_SEPARATOR);if(n===-1||n===0||n===e.length-1)throw new c(s.INVALID_FORMAT,`Invalid icon format: "${e}". Expected format: "prefix:name"`);return{prefix:e.substring(0,n).trim(),name:e.substring(n+1).trim()}}async renderIcon(e){let t=this.getState(e);if(e.hasAttribute(`data-prerendered`))return;let n=this.getConfig(e),r=n.name,i=r!==t.activeIconName;i&&t.renderAbortController&&(t.renderAbortController.abort(),t.renderAbortController=null),i&&(t.activeIconName=r||null),t.renderAbortController||=new AbortController;let a=t.renderAbortController;try{t.renderStatus=`loading`,this.renderLoading(e,n);let r=await this.fetchIcon(n.name,a.signal);if(a.signal.aborted)return;this.renderSvg(e,r,n)}catch(n){if(a.signal.aborted)return;t.renderStatus=`failed`;let r=n instanceof c?n:new c(s.FETCH_FAILED,n instanceof Error?n.message:`Unknown error occurred`,n instanceof Error?n:void 0);await this.renderError(e,r,a.signal)}finally{t.renderAbortController===a&&(t.renderAbortController=null)}}renderLoading(e,t){e.setAttribute(`data-oiwc-state`,`loading`),[`data-oiwc-error-type`,`data-oiwc-original-icon`,`data-oiwc-expanded`].forEach(t=>e.removeAttribute(t)),t.width&&(e.style.width=`${t.width}px`),t.height&&(e.style.height=`${t.height}px`),e.innerHTML=``}renderSvg(e,n,r){let i=this.getState(e),a=i.lastError!==null;e.innerHTML=n,i.cachedSvgElement=e.querySelector(`svg`),i.cachedSvgElement&&(i.originalWidth||=i.cachedSvgElement.getAttribute(`width`),i.originalHeight||=i.cachedSvgElement.getAttribute(`height`),i.cachedSvgElement.setAttribute(`aria-hidden`,`true`),i.cachedSvgElement.setAttribute(`focusable`,`false`),this.passAttributesToSvg(e,i.cachedSvgElement)),i.renderStatus=`rendered`,t.CLEANUP_ATTRS.forEach(t=>e.removeAttribute(t)),e.style.width=``,e.style.height=``,e.style.cursor=``,e.dispatchEvent(new CustomEvent(`omni-icon:loaded`,{detail:{iconName:r.name,wasError:a,element:e},bubbles:!0,composed:!0})),i.lastError=null}async renderError(e,n,r){let i=this.getState(e);i.lastError=n;let a=this.getConfig(e);e.setAttribute(`data-oiwc-state`,`error`),e.setAttribute(`data-oiwc-error-type`,n.type),e.setAttribute(`data-oiwc-original-icon`,a.name),a.width&&(e.style.width=`${a.width}px`),a.height&&(e.style.height=`${a.height}px`);try{let n=await this.fetchIcon(t.FALLBACK_ICON,r,t.FALLBACK_PRIORITY);if(r?.aborted)return;e.innerHTML=n;let i=e.querySelector(`svg`);i&&(i.setAttribute(`aria-hidden`,`true`),i.setAttribute(`focusable`,`false`),this.passAttributesToSvg(e,i))}catch{if(r?.aborted)return;e.innerHTML=``}await this.ensureErrorObserver(),e.dispatchEvent(new CustomEvent(`omni-icon:error`,{detail:{type:n.type,message:n.message,iconName:a.name,element:e},bubbles:!0,composed:!0}))}async ensureErrorObserver(){!t.errorObserverLoaded&&!t.errorObserverPromise&&(t.errorObserverPromise=e(async()=>{let{ErrorObserver:e}=await import(`./ErrorObserver-BL-dIQLj.js`);return{ErrorObserver:e}},[],import.meta.url).then(({ErrorObserver:e})=>{new e,t.errorObserverLoaded=!0})),await t.errorObserverPromise}shouldSkipAttribute(e){return e.startsWith(`data-oiwc-`)||t.RESERVED_ATTRS.has(e)}passAttributesToSvg(e,t){Array.from(e.attributes).forEach(e=>{this.shouldSkipAttribute(e.name)||t.setAttribute(e.name,e.value)})}updateSvgAttributes(e){let n=this.getState(e),r=n.cachedSvgElement||e.querySelector(`svg`);if(!r)return;n.cachedSvgElement=r;let i=new Map;Array.from(e.attributes).forEach(e=>{this.shouldSkipAttribute(e.name)||i.set(e.name,e.value)}),Array.from(r.attributes).forEach(e=>{let n=e.name;!t.SVG_ATTRS.has(n)&&!t.RESERVED_ATTRS.has(n)&&!i.has(n)&&r.removeAttribute(n)}),i.forEach((e,t)=>{r.setAttribute(t,e)})}async fetchIcon(e,t,n=0){let{prefix:r,name:i}=this.parseIconName(e);return g(e,r,i,{signal:t,priority:n})}};export{j as OmniIconRenderer};
//# sourceMappingURL=OmniIconRenderer-CPDO0Yqc.js.map